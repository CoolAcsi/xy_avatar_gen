<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>头像生成器</title>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
		integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
		crossorigin="anonymous"></script>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
		integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
	<link rel="preload" href="font/禹卫书法云墨繁体.TTF" as="font" crossorigin="anonymous">
	<link rel="preload" href="font/演示镇魂行楷.TTF" as="font" crossorigin="anonymous">
	<link rel="preload" href="font/AA剑鸣手书.TTF" as="font" crossorigin="anonymous">
	<link rel="preload" href="font/AA狂派手书.TTF" as="font" crossorigin="anonymous">
	<!-- <link rel="preload"
		href="http://snebs07m7.hn-bkt.clouddn.com/front/%E7%A6%B9%E5%8D%AB%E4%B9%A6%E6%B3%95%E4%BA%91%E5%A2%A8%E7%B9%81%E4%BD%93.TTF"
		as="font">
	<link rel="preload"
		href="http://snebs07m7.hn-bkt.clouddn.com/front/%E6%BC%94%E7%A4%BA%E9%95%87%E9%AD%82%E8%A1%8C%E6%A5%B7.TTF"
		as="font">
	<link rel="preload" href="http://snebs07m7.hn-bkt.clouddn.com/front/AA%E5%89%91%E9%B8%A3%E6%89%8B%E4%B9%A6.TTF"
		as="font">
	<link rel="preload" href="http://snebs07m7.hn-bkt.clouddn.com/front/AA%E7%8B%82%E6%B4%BE%E6%89%8B%E4%B9%A6.TTF"
		as="font"> -->
	<style>
		canvas {
			/* border: 1px solid black; */
			touch-action: none;
			padding-top: 3vh;
			/* 防止触摸滚动干扰拖拽 */
		}

		body {
			width: 100vw;
			height: 100vh;
			padding: 0;
			margin: 0;
		}

		/* .container {
			width: 100%;
			text-align: center;
			overflow-y: scroll;
		} */
		/* 
		.console {
			width: 40%;
			text-align: left;
			padding: 4vw;
			float: left;
			text-align: center;
		} */

		/* .avatar {
			margin-left: 5%;
			width: 40%;
			height: 40vw;
			float: left;
		} */

		.hidden {
			visibility: hidden;
		}



		/* @font-face {
			font-family: '禹卫书法云墨繁体';
			src: url('http://snebs07m7.hn-bkt.clouddn.com/front/%E7%A6%B9%E5%8D%AB%E4%B9%A6%E6%B3%95%E4%BA%91%E5%A2%A8%E7%B9%81%E4%BD%93.TTF') format('truetype');
			font-weight: normal;
			font-style: normal;
		}

		@font-face {
			font-family: '演示镇魂行楷';
			src: url('http://snebs07m7.hn-bkt.clouddn.com/front/%E6%BC%94%E7%A4%BA%E9%95%87%E9%AD%82%E8%A1%8C%E6%A5%B7.TTF') format('truetype');
			font-weight: normal;
			font-style: normal;
		}

		@font-face {
			font-family: 'AA剑鸣手书';
			src: url('http://snebs07m7.hn-bkt.clouddn.com/front/AA%E5%89%91%E9%B8%A3%E6%89%8B%E4%B9%A6.TTF') format('truetype');
			font-weight: normal;
			font-style: normal;
		}

		@font-face {
			font-family: 'AA狂派手书';
			src: url('http://snebs07m7.hn-bkt.clouddn.com/front/AA%E7%8B%82%E6%B4%BE%E6%89%8B%E4%B9%A6.TTF') format('truetype');
			font-weight: normal;
			font-style: normal;
		} */


		@font-face {
			font-family: '禹卫书法云墨繁体';
			src: url('font/禹卫书法云墨繁体.TTF') format('truetype');
			font-weight: normal;
			font-style: normal;
		}

		@font-face {
			font-family: '演示镇魂行楷';
			src: url('font/演示镇魂行楷.TTF') format('truetype');
			font-weight: normal;
			font-style: normal;
		}

		@font-face {
			font-family: 'AA剑鸣手书';
			src: url('font/AA剑鸣手书.TTF') format('truetype');
			font-weight: normal;
			font-style: normal;
		}

		@font-face {
			font-family: 'AA狂派手书';
			src: url('font/AA狂派手书.TTF') format('truetype');
			font-weight: normal;
			font-style: normal;
		}
	</style>
</head>

<body>


	<div id="team_select_popup"
		style="z-index: 9999; width: 100%; height: 100vh; background-color: gray; opacity: 0.9; position: fixed; text-align: center; line-height: 40vh; padding: 4vw;">
		<label for="textColor"> </label>
		<select id="team_select" class="form-select form-select-lg" name="team_select" style="font-size: large;">
			<option value="no">选择你的俱乐部</option>
			<option value="wc">忘川</option>
			<option value="tm">天命</option>
		</select>
	</div>
	<div class="container text-center">
		<!-- <h1>头像生成器</h1> -->
		<div class="row justify-content-md-center">
			<div class="canvas col-md-auto"><canvas id="canvas" style="width: 100%;"></canvas></div>
			<div class="col-md-auto">
				<br>
				<button id="reset_team" class="btn btn-primary" onclick="resetTeam()"
					style="width: 100%;">重选俱乐部</button>
				<br><br>
				<!-- <br><br> -->
				<div class="input-group">
					<span class="input-group-text">昵称</span>
					<input type="text" id="textInput" class="form-control" placeholder="在此输入昵称" maxlength="3">
				</div>

				<br>

				<div class="input-group">
					<span class="input-group-text">昵称比例</span>
					<input type="number" class="form-control" id="fontScale" value="100">
					<span class="input-group-text">%</span>
				</div>

				<br>
				<div class="input-group">
					<span class="input-group-text">昵称颜色</span>
					<input type="color" class="form-control form-control-color" id="textColor" value="#ffffff">
				</div>
				<br>

				<input type="checkbox" class="btn-check" id="isVerticalText" autocomplete="off">
				<label class="btn btn-outline-danger" for="isVerticalText" style="width: 100%;">竖向展示昵称</label>

				<br><br>
				<!-- <label for="fontGlobalAlpha">文字透明度：</label>
			<input type="number" id="fontGlobalAlpha" maxlength="2" min="1" max="10" value="5">
			<br><br> -->

				<div class="input-group">
					<span class="input-group-text">背景</span>
					<select id="bg_select" class="form-select" class="form-select" name="bg_select" id="lang">
						<option class="wc_opt" value="wc_red_v3">忘川红</option>
						<option class="wc_opt" value="wc_blue_v3">忘川蓝</option>
						<option class="wc_opt" value="wc_green_v3">忘川绿</option>
						<option class="wc_opt" value="wc_orange_v3">忘川橙</option>
						<option class="wc_opt" value="wc_purple_v3">忘川紫</option>
						<option class="tm_opt" value="tm_red_v3">天命红</option>
						<option class="tm_opt" value="tm_blue_v3">天命蓝</option>
						<option class="tm_opt" value="tm_green_v3">天命绿</option>
						<option class="tm_opt" value="tm_orange_v3">天命橙</option>
						<option class="tm_opt" value="tm_purple_v3">天命紫</option>
					</select>
					<!-- <input type="color" class="form-control form-control-color" id="textColor" value="#ffffff"> -->
				</div>
				<br>
				<div class="input-group">
					<span class="input-group-text">字体</span>
					<select id="font_select" class="form-select" name="font_select" id="lang">
						<option value="禹卫书法云墨繁体">禹卫书法云墨繁体</option>
						<option value="演示镇魂行楷">镇魂行楷</option>
						<option value="AA剑鸣手书">AA剑鸣手书</option>
						<option value="AA狂派手书">AA狂派手书</option>
					</select>
				</div>
				<br>

				<div class="input-group">
					<span class="input-group-text">俱乐部水印</span>
					<select id="logo_select" class="form-select" name="logo_select" id="lang">
						<option class="wc_opt" value="logo_wc_white.jpg">忘川白</option>
						<option class="wc_opt" value="logo_wc_red.jpg">忘川红</option>
						<option class="wc_opt" value="logo_wc_black.jpg">忘川黑</option>
						<option class="wc_opt" value="logo_wc_yellow.jpg">忘川黄</option>
						<option class="tm_opt" value="logo_white.jpg">天命白</option>
						<option class="tm_opt" value="logo_red.jpg">天命红</option>
						<option class="tm_opt" value="logo_black.png">天命黑</option>
						<option class="tm_opt" value="logo_yellow.png">天命黄</option>
						<!-- <option class="none" value="none">无</option> -->
					</select>
				</div>
				<br>
				<div class="input-group">
					<label for="logo_position_x" class="form-label">水印位置-横向</label>
					<input type="range" class="form-range" min="0" max="400" step="1" value="260" id="logo_position_x">
				</div>
				<br>
				<div class="input-group">
					<label for="logo_position_y" class="form-label">水印位置-竖向</label>
					<input type="range" class="form-range" min="0" max="400" step="1" value="150" id="logo_position_y">
				</div>
				<br>


				<div class="input-group">
					<span class="input-group-text">挂饰</span>
					<select id="pendant_select" class="form-select" name="pendant_select" id="lang">
						<option value="streamer">飘带</option>
						<option value="cloud">云</option>
						<option value="smoke">烟</option>
						<option value="none">无</option>
					</select>
				</div>
				<br>

				<div class="input-group">
					<label class="input-group-text" for="sticker_upoader">上传贴纸</label>
					<input type="file" class="form-control" id="sticker_upoader" accept="image/*">
				</div>
				<br>
				<button class="btn btn-success" id="saveButton" style="width: 100%;">保存图片</button>
				<br><br>
			</div>
		</div>
	</div>

	<script>
		const canvas = document.getElementById('canvas');
		const ctx = canvas.getContext('2d');
		const imageUploader = document.getElementById('sticker_upoader');
		const textInput = document.getElementById('textInput');
		const isVerticalTextInput = document.getElementById('isVerticalText');
		const fontScaleInput = document.getElementById('fontScale');
		// const fontGlobalAlpha = document.getElementById('fontGlobalAlpha');
		const textColorInput = document.getElementById('textColor');
		const saveButton = document.getElementById('saveButton');
		const bgSelect = document.getElementById('bg_select');
		const fontSelect = document.getElementById('font_select');
		const logoSelect = document.getElementById('logo_select');
		const logoPositionXInput = document.getElementById('logo_position_x');
		const logoPositionYInput = document.getElementById('logo_position_y');
		const pendantSelect = document.getElementById('pendant_select');
		const teamSelect = document.getElementById('team_select');
		const teamSelectPopup = document.getElementById('team_select_popup');
		const tmOpts = document.getElementsByClassName('tm_opt');
		const wcOpts = document.getElementsByClassName('wc_opt');

		var selectedFont = "禹卫书法云墨繁体";

		// font.load().then(function (loadedFont) {
		// 	document.fonts.add(loadedFont);
		// 	// 现在字体已加载，可以在Canvas中使用
		// 	// imageUploader.disabled = false

		// }).catch(function (error) {
		// 	console.error('Failed to load the font', error);
		// });

		function resetTeam() {
			teamSelectPopup.style.visibility = "visible"
		}


		teamSelect.addEventListener('change', (event) => {
			if (event.target.value == "tm") {
				Array.prototype.forEach.call(wcOpts, function (opt) {
					opt.style.display = "none"
				});
				Array.prototype.forEach.call(tmOpts, function (opt) {
					opt.style.display = "inline"
				});
				bgSelect.value = "tm_red_v3"
				logoSelect.value = "logo_white.jpg"
				logo.src = "./img/logo_white.jpg"
				image.src = "./img/tm_red_v3.jpg"
			} else if (event.target.value == "wc") {
				Array.prototype.forEach.call(wcOpts, function (opt) {
					opt.style.display = "inline"
				});
				Array.prototype.forEach.call(tmOpts, function (opt) {
					opt.style.display = "none"
				});
				bgSelect.value = "wc_red_v3"
				logoSelect.value = "logo_wc_white.jpg"
				logo.src = "./img/logo_wc_white.jpg"
				image.src = "./img/wc_red_v3.jpg"
			} else {
				Array.prototype.forEach.call(wcOpts, function (opt) {
					opt.style.display = "inline"
				});
				Array.prototype.forEach.call(tmOpts, function (opt) {
					opt.style.display = "inline"
				});
			}
			teamSelectPopup.style.visibility = "hidden"
		});


		let logo = new Image();
		let image = new Image();
		let sticker = new Image();
		let pendant = new Image();
		pendantStruct = new Object();
		pendant.src = "./img/streamer.jpg"
		pendantStruct.Width = 318
		pendantStruct.X = 42
		pendantStruct.Y = 98
		pendantStruct.Show = true


		logo.setAttribute('crossorigin', 'anonymous');
		logo.crossOrigin = 'anonymous';
		image.setAttribute('crossorigin', 'anonymous');
		image.crossOrigin = 'anonymous';
		logo.onload = () => {
			// image.height = auto;
			drawCanvas();
		};

		image.onload = () => {
			canvas.width = 400;
			canvas.height = 400;
			drawCanvas();
		};

		var stickerW = 0
		var stickerH = 0
		sticker.onload = () => {
			new Promise(resolve => setTimeout(resolve, 500)).then(() => {
				drawCanvas();
			});
		};

		pendant.onload = () => {
			new Promise(resolve => setTimeout(resolve, 500)).then(() => {
				drawCanvas();
			});
		};

		image.src = "./img/wc_red_v3.jpg"

		let textPosition = {
			x: 120,
			y: 198
		}; // 初始文字位置
		let isDragging = false;
		let touchStartOffset = {
			x: 0,
			y: 0
		}; // 触摸开始时的偏移量

		// 加载图片
		var bgImg = "./img/wc_red_v3.jpg"
		bgSelect.addEventListener('change', (event) => {

			bgImg = "./img/" + event.target.value + ".jpg"
			// const file = event.target.files[0];
			if (bgImg) {
				// const reader = new FileReader("./img/orange.jpg");
				// reader.onload = (e) => {
				image.src = bgImg
				// };
			}
		});


		fontSelect.addEventListener('change', (event) => {
			selectedFont = event.target.value
			drawCanvas();
		});


		logoSelect.addEventListener('change', (event) => {
			logo.src = "./img/" + event.target.value
			drawCanvas();
		});

		pendantSelect.addEventListener('change', (event) => {
			switch (event.target.value) {
				case "cloud":
					pendantStruct.Width = 285
					pendantStruct.X = 59
					pendantStruct.Y = 52
					pendantStruct.show = true
					break
				case "streamer":
					pendantStruct.Width = 318
					pendantStruct.X = 42
					pendantStruct.Y = 98
					pendantStruct.Show = true
					break
				case "smoke":
					pendantStruct.Width = 292
					pendantStruct.X = 52
					pendantStruct.Y = 58
					pendantStruct.Show = true
					break
				default:
					pendantStruct.Show = false
					break
			}
			if (event.target.value != "none") {
				pendant.src = "./img/" + event.target.value + ".jpg"
			} else{
				pendant.src = "./img/streamer.jpg"
			}
		});


		// 加载图片
		imageUploader.addEventListener('change', (event) => {
			const file = event.target.files[0];
			if (file) {
				const reader = new FileReader();
				reader.onload = (e) => {
					// sticker.onload = () => {
					// 	drawCanvas();
					// };
					sticker.src = e.target.result;
				};
				reader.readAsDataURL(file);
			}
		});

		// 绘制画布
		function drawCanvas() {
			ctx.clearRect(0, 0, canvas.width, canvas.height);
			ctx.drawImage(image, 0, 0, 400, 400);

			if (pendantStruct.Show) {
				console.info(pendantStruct.X, pendantStruct.Y, pendantStruct.Width)
				var pendantHeight = pendantStruct.Width * pendant.height / pendant.width
				ctx.drawImage(pendant, pendantStruct.X, pendantStruct.Y, pendantStruct.Width, pendantHeight);
			}

			ctx.drawImage(logo, logoPositionXInput.value, logoPositionYInput.value, 60, 100);
			
			var stickerW = 130
			var stickerH = sticker.height * stickerW / sticker.width
			ctx.drawImage(sticker, 135, 130, stickerW, stickerH);
			drawText();
		}


		// 绘制竖向文字
		function drawText() {

			function fn() {
				// let globalAlphaNum = fontGlobalAlpha.value
				// if (globalAlphaNum <= 0 || globalAlphaNum > 10) {
				// 	console.log(globalAlphaNum);
				// 	return
				// }
				const text = textInput.value;
				// const fontSize = fontSizeInput.value;
				const textColor = hexToRGBA(textColorInput.value);
				// ctx.globalAlpha =  // 设置透明度为50%

				var fs = 180
				if (text.length == 1) {
					fs = 180
				} else if (text.length == 2) {
					fs = 120
				} else {
					fs = 85
				}
				fs = fs * fontScaleInput.value / 100
				ctx.font = `${fs}px ${selectedFont}`;

				// ctx.font = `${fontSize}px 'AlimamaDaoLiTi'`;

				// ctx.fillStyle = changeOpacity(textColor, globalAlphaNum / 10);
				ctx.fillStyle = changeOpacity(textColor, 1);
				ctx.textAlign = `center`

				var y = 220 - ((text.length - 1) * fs) / 2
				if (isVerticalTextInput.checked) {
					// 按竖向逐行绘制
					for (let i = 0; i < text.length; i++) {
						ctx.fillText(text[i], 200, y + (i * fs));
					}
				} else {
					ctx.fillText(text, 200, 220);
				}
			}
			const debouncedDrawText = debounce(fn, 300);

			debouncedDrawText()
		}

		// 开始触摸
		// canvas.addEventListener('touchstart', (e) => {
		// 	const rect = canvas.getBoundingClientRect();
		// 	const touch = e.touches[0];
		// 	const touchX = touch.clientX - rect.left;
		// 	const touchY = touch.clientY - rect.top;

		// 	const textWidth = ctx.measureText(textInput.value[0]).width; // 文字宽度
		// 	const textHeight = fontSizeInput.value * textInput.value.length; // 文字高度

		// 	// if (
		// 	//     touchX >= textPosition.x &&
		// 	//     touchX <= textPosition.x + textWidth &&
		// 	//     touchY >= textPosition.y &&
		// 	//     touchY <= textPosition.y + textHeight
		// 	// ) {

		// 	// }
		// 	isDragging = true;
		// 	touchStartOffset.x = touchX - textPosition.x;
		// 	touchStartOffset.y = touchY - textPosition.y;
		// 	console.log(textPosition);
		// });

		// 触摸移动
		// canvas.addEventListener('touchmove', (e) => {
		// 	if (isDragging) {
		// 		e.preventDefault(); // 阻止页面滚动
		// 		const rect = canvas.getBoundingClientRect();
		// 		const touch = e.touches[0];
		// 		textPosition.x = touch.clientX - rect.left - touchStartOffset.x;
		// 		textPosition.y = touch.clientY - rect.top - touchStartOffset.y;
		// 		drawCanvas();
		// 	}
		// });

		// 结束触摸
		// canvas.addEventListener('touchend', () => {
		// 	isDragging = false;
		// });

		// 实时更新文字内容或样式
		textInput.addEventListener('input', drawCanvas);
		// fontSizeInput.addEventListener('input', drawCanvas);
		textColorInput.addEventListener('input', drawCanvas);
		isVerticalTextInput.addEventListener('input', drawCanvas);

		logoPositionXInput.addEventListener('input', drawCanvas);
		logoPositionYInput.addEventListener('input', drawCanvas);
		fontScaleInput.addEventListener('input', drawCanvas);
		// fontGlobalAlpha.addEventListener('input', drawCanvas);

		// fontGlobalAlpha.addEventListener('input', function () {
		// 	console.log(fontGlobalAlpha.value);
		// 	if (fontGlobalAlpha.value < 0 || fontGlobalAlpha.value > 10) {
		// 		fontGlobalAlpha.value = 0; // 清空不符合要求的输入
		// 		return
		// 	} else {
		// 		drawCanvas()
		// 	}
		// });


		// 保存图片
		saveButton.addEventListener('click', () => {
			const link = document.createElement('a');
			link.download = 'edited-image.png';
			link.href = canvas.toDataURL('image/png');
			link.click();

			const img = document.createElement('img');
			img.setAttribute('crossorigin', 'anonymous');
			img.crossOrigin = 'anonymous';
			img.src = canvas.toDataURL('image/png');
			img.style.width = '100%'; // 确保图片适应屏幕宽度
			img.style.height = 'auto';
			img.alt = 'Edited Image';

			const modal = document.createElement('div');
			modal.style.position = 'fixed';
			modal.style.left = '0';
			modal.style.top = '0';
			modal.style.width = '100%';
			modal.style.height = '100%';
			modal.style.backgroundColor = 'rgba(0,0,0,0.8)';
			modal.style.display = 'flex';
			modal.style.justifyContent = 'center';
			modal.style.alignItems = 'center';
			modal.style.zIndex = '1000';

			modal.appendChild(img);
			document.body.appendChild(modal);

			// // 点击任意位置关闭预览
			// modal.addEventListener('click', () => {
			// 	document.body.removeChild(modal);
			// });
		});


		/**
		 * @param {Object} func
		 * @param {Object} wait
		 * 防抖操作
		 */
		function debounce(func, wait) {
			let timeout;
			return function () {
				const context = this;
				const args = arguments;
				clearTimeout(timeout);
				timeout = setTimeout(() => func.apply(context, args), wait);
			};
		}

		/**
		 * 转换颜色
		 */
		function hexToRGBA(hex, alpha = 1) {
			// 去除十六进制颜色的前缀（如果有）
			hex = hex.replace('#', '');
			// 解析十六进制颜色值
			const r = parseInt(hex.substring(0, 2), 16);
			const g = parseInt(hex.substring(2, 4), 16);
			const b = parseInt(hex.substring(4, 6), 16);
			// 返回 RGBA 颜色字符串
			return `rgba(${r}, ${g}, ${b}, ${alpha})`;
		}

		/**
		 * @param {Object} rgbaString
		 * @param {Object} newOpacity
		 * 修改透明度
		 */
		function changeOpacity(rgbaString, newOpacity) {
			// 使用正则表达式提取RGBA中的各个组成部分
			const rgbaRegex = /rgba\((\d+),\s*(\d+),\s*(\d+),\s*([\d.]+)\)/;
			const matches = rgbaRegex.exec(rgbaString);
			if (matches) {
				const r = parseInt(matches[1], 10);
				const g = parseInt(matches[2], 10);
				const b = parseInt(matches[3], 10);
				// 构造新的RGBA字符串，使用新的透明度值
				return `rgba(${r}, ${g}, ${b}, ${newOpacity})`;
			}
			return rgbaString; // 如果输入格式不正确，返回原始字符串
		}
	</script>
</body>

</html>