<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>头像生成器</title>
	<style>
		canvas {
			border: 1px solid black;
			touch-action: none;
			/* 防止触摸滚动干扰拖拽 */
		}

		body {
			width: 100vw;
			height: 100vh;
			padding: 0;
			margin: 0;
		}

		.container {
			width: 100%;
			text-align: center;
			overflow-y: scroll;
		}

		.console {
			width: 40%;
			text-align: left;
			padding: 4vw;
			float: left;
			text-align: center;
		}

		.avatar {
			margin-left: 5%;
			width: 40%;
			height: 40vw;
			float: left;
		}

		@font-face {
			font-family: 'AlimamaDaoLiTi';
			src: url('font/AlimamaDaoLiTi.ttf') format('truetype');
			font-weight: normal;
			font-style: normal;
		}
	</style>
</head>

<body>
	<div class="container">
		<h1>头像生成器</h1>
		<div class="avatar"><canvas style="width: 100%; height: 100%;" id="canvas"></canvas></div>


		<div class="console">
			<!-- <input type="file" id="imageUploader" disabled accept="image/*"> -->
			<!-- <br><br> -->
			<label for="textInput">文字：</label>
			<input type="text" id="textInput" maxlength="3" placeholder="在此输入文字">
			<br><br>
			<!-- <label for="fontSize">文字大小：</label>
			<input type="number" id="fontSize" value="150" disabled min="10">
			<br><br> -->
			<label for="textColor">文字颜色：</label>
			<input type="color" id="textColor" value="#ffffff">
			<br><br>
			<!-- <label for="fontGlobalAlpha">文字透明度：</label>
			<input type="number" id="fontGlobalAlpha" maxlength="2" min="1" max="10" value="5">
			<br><br> -->
			<label for="textColor">背景：</label>
			<select id="bg_select" name="bg_select" id="lang">
				<option value="red">红色</option>
				<option value="blue">蓝色</option>
				<option value="green">绿色</option>
				<option value="orange">橙色</option>
				<option value="purple">紫色</option>
			</select>
			<br><br>
			<button id="saveButton">保存图片</button>
		</div>
	</div>


	<script>
		const canvas = document.getElementById('canvas');
		const ctx = canvas.getContext('2d');
		const imageUploader = document.getElementById('imageUploader');
		const textInput = document.getElementById('textInput');
		// const fontSizeInput = document.getElementById('fontSize');
		// const fontGlobalAlpha = document.getElementById('fontGlobalAlpha');
		const textColorInput = document.getElementById('textColor');
		const saveButton = document.getElementById('saveButton');
		const bgSelect = document.getElementById('bg_select');



		const font = new FontFace('AlimamaDaoLiTi', 'url(font/AlimamaDaoLiTi.woff2)', {
			style: 'normal',
			weight: 'normal'
		});

		font.load().then(function (loadedFont) {
			document.fonts.add(loadedFont);
			// 现在字体已加载，可以在Canvas中使用
			// imageUploader.disabled = false

		}).catch(function (error) {
			console.error('Failed to load the font', error);
		});


		let image = new Image();
		image.onload = () => {
			console.info(bgImg + " loading...")
			canvas.width = image.width;
			canvas.height = image.height;
			drawCanvas();
		};

		image.src = "./img/red.jpg"

		let textPosition = {
			x: 120,
			y: 198
		}; // 初始文字位置
		let isDragging = false;
		let touchStartOffset = {
			x: 0,
			y: 0
		}; // 触摸开始时的偏移量

		// 加载图片
		var bgImg = "./img/blue.jpg"
		bgSelect.addEventListener('change', (event) => {
			switch (event.target.value) {
				case "red":
					bgImg = "./img/red.jpg"
					break
				case "blue":
					bgImg = "./img/blue.jpg"
					break
				case "purple":
					bgImg = "./img/purple.jpg"
					break
				case "green":
					bgImg = "./img/green.jpg"
					break
				case "orange":
					bgImg = "./img/orange.jpg"
					break
			}
			// const file = event.target.files[0];
			if (bgImg) {
				// const reader = new FileReader("./img/orange.jpg");
				// reader.onload = (e) => {

				image.src = bgImg
				// };
			}
		});

		// 绘制画布
		function drawCanvas() {
			ctx.clearRect(0, 0, canvas.width, canvas.height);
			ctx.drawImage(image, 0, 0);
			drawText();
		}


		// 绘制竖向文字
		function drawText() {

			function fn() {
				// let globalAlphaNum = fontGlobalAlpha.value
				// if (globalAlphaNum <= 0 || globalAlphaNum > 10) {
				// 	console.log(globalAlphaNum);
				// 	return
				// }
				const text = textInput.value;
				// const fontSize = fontSizeInput.value;
				const textColor = hexToRGBA(textColorInput.value);
				// ctx.globalAlpha =  // 设置透明度为50%

				var fs  = 180
				if (text.length == 1) {
					fs = 170
				} else if (text.length == 2) {
					fs = 120
				} else {
					fs = 85
				}
				ctx.font = `${fs}px 'AlimamaDaoLiTi'`;
				// ctx.font = `${fontSize}px 'AlimamaDaoLiTi'`;

				// ctx.fillStyle = changeOpacity(textColor, globalAlphaNum / 10);
				ctx.fillStyle = changeOpacity(textColor, 1);
				ctx.textAlign = `center`

				// 按竖向逐行绘制
				// for (let i = 0; i < text.length; i++) {
				// 	ctx.fillText(text[i], textPosition.x + (i * fontSize)/1.4, textPosition.y);
				// }
				
				ctx.fillText(text, 195, textPosition.y);
			}
			const debouncedDrawText = debounce(fn, 300);

			debouncedDrawText()
		}

		// 开始触摸
		// canvas.addEventListener('touchstart', (e) => {
		// 	const rect = canvas.getBoundingClientRect();
		// 	const touch = e.touches[0];
		// 	const touchX = touch.clientX - rect.left;
		// 	const touchY = touch.clientY - rect.top;

		// 	const textWidth = ctx.measureText(textInput.value[0]).width; // 文字宽度
		// 	const textHeight = fontSizeInput.value * textInput.value.length; // 文字高度

		// 	// if (
		// 	//     touchX >= textPosition.x &&
		// 	//     touchX <= textPosition.x + textWidth &&
		// 	//     touchY >= textPosition.y &&
		// 	//     touchY <= textPosition.y + textHeight
		// 	// ) {

		// 	// }
		// 	isDragging = true;
		// 	touchStartOffset.x = touchX - textPosition.x;
		// 	touchStartOffset.y = touchY - textPosition.y;
		// 	console.log(textPosition);
		// });

		// 触摸移动
		// canvas.addEventListener('touchmove', (e) => {
		// 	if (isDragging) {
		// 		e.preventDefault(); // 阻止页面滚动
		// 		const rect = canvas.getBoundingClientRect();
		// 		const touch = e.touches[0];
		// 		textPosition.x = touch.clientX - rect.left - touchStartOffset.x;
		// 		textPosition.y = touch.clientY - rect.top - touchStartOffset.y;
		// 		drawCanvas();
		// 	}
		// });

		// 结束触摸
		// canvas.addEventListener('touchend', () => {
		// 	isDragging = false;
		// });

		// 实时更新文字内容或样式
		textInput.addEventListener('input', drawCanvas);
		// fontSizeInput.addEventListener('input', drawCanvas);
		textColorInput.addEventListener('input', drawCanvas);
		// fontGlobalAlpha.addEventListener('input', drawCanvas);

		// fontGlobalAlpha.addEventListener('input', function () {
		// 	console.log(fontGlobalAlpha.value);
		// 	if (fontGlobalAlpha.value < 0 || fontGlobalAlpha.value > 10) {
		// 		fontGlobalAlpha.value = 0; // 清空不符合要求的输入
		// 		return
		// 	} else {
		// 		drawCanvas()
		// 	}
		// });


		// 保存图片
		saveButton.addEventListener('click', () => {
			const link = document.createElement('a');
			link.download = 'edited-image.png';
			link.href = canvas.toDataURL('image/png');
			link.click();

			const img = document.createElement('img');
			img.src = canvas.toDataURL('image/png');
			img.style.width = '100%'; // 确保图片适应屏幕宽度
			img.style.height = 'auto';
			img.alt = 'Edited Image';

			const modal = document.createElement('div');
			modal.style.position = 'fixed';
			modal.style.left = '0';
			modal.style.top = '0';
			modal.style.width = '100%';
			modal.style.height = '100%';
			modal.style.backgroundColor = 'rgba(0,0,0,0.8)';
			modal.style.display = 'flex';
			modal.style.justifyContent = 'center';
			modal.style.alignItems = 'center';
			modal.style.zIndex = '1000';

			modal.appendChild(img);
			document.body.appendChild(modal);

			// 点击任意位置关闭预览
			modal.addEventListener('click', () => {
				document.body.removeChild(modal);
			});
		});


		/**
		 * @param {Object} func
		 * @param {Object} wait
		 * 防抖操作
		 */
		function debounce(func, wait) {
			let timeout;
			return function () {
				const context = this;
				const args = arguments;
				clearTimeout(timeout);
				timeout = setTimeout(() => func.apply(context, args), wait);
			};
		}

		/**
		 * 转换颜色
		 */
		function hexToRGBA(hex, alpha = 1) {
			// 去除十六进制颜色的前缀（如果有）
			hex = hex.replace('#', '');
			// 解析十六进制颜色值
			const r = parseInt(hex.substring(0, 2), 16);
			const g = parseInt(hex.substring(2, 4), 16);
			const b = parseInt(hex.substring(4, 6), 16);
			// 返回 RGBA 颜色字符串
			return `rgba(${r}, ${g}, ${b}, ${alpha})`;
		}

		/**
		 * @param {Object} rgbaString
		 * @param {Object} newOpacity
		 * 修改透明度
		 */
		function changeOpacity(rgbaString, newOpacity) {
			// 使用正则表达式提取RGBA中的各个组成部分
			const rgbaRegex = /rgba\((\d+),\s*(\d+),\s*(\d+),\s*([\d.]+)\)/;
			const matches = rgbaRegex.exec(rgbaString);
			if (matches) {
				const r = parseInt(matches[1], 10);
				const g = parseInt(matches[2], 10);
				const b = parseInt(matches[3], 10);
				// 构造新的RGBA字符串，使用新的透明度值
				return `rgba(${r}, ${g}, ${b}, ${newOpacity})`;
			}
			return rgbaString; // 如果输入格式不正确，返回原始字符串
		}
	</script>
</body>

</html>